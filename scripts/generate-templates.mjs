/**
 * Generates .docx templates for Foxit Document Generation API.
 * Run: node scripts/generate-templates.mjs
 * Output: public/templates/certificate-template.docx, study-report-template.docx
 */

import {
  Document,
  Packer,
  Paragraph,
  TextRun,
  Table,
  TableRow,
  TableCell,
  WidthType,
  AlignmentType,
  BorderStyle,
  HeadingLevel,
} from 'docx';
import { writeFileSync } from 'fs';

// ─── Helper: create a simple text paragraph ──────────────
function p(text, options = {}) {
  return new Paragraph({
    alignment: options.center ? AlignmentType.CENTER : AlignmentType.LEFT,
    spacing: { after: options.spacingAfter ?? 200 },
    children: [
      new TextRun({
        text,
        bold: options.bold ?? false,
        size: options.size ?? 24, // half-points, 24 = 12pt
        font: options.font ?? 'Calibri',
        color: options.color,
      }),
    ],
  });
}

// ─── Helper: table header cell ───────────────────────────
function headerCell(text, width) {
  return new TableCell({
    width: { size: width, type: WidthType.PERCENTAGE },
    shading: { fill: '2563EB', color: 'FFFFFF' },
    children: [
      new Paragraph({
        children: [new TextRun({ text, bold: true, size: 20, font: 'Calibri', color: 'FFFFFF' })],
      }),
    ],
  });
}

// ─── Helper: table data cell ─────────────────────────────
function dataCell(text, width) {
  return new TableCell({
    width: { size: width, type: WidthType.PERCENTAGE },
    children: [
      new Paragraph({
        children: [new TextRun({ text, size: 20, font: 'Calibri' })],
      }),
    ],
  });
}

// ─── Certificate Template ────────────────────────────────
const certificateDoc = new Document({
  sections: [
    {
      properties: {
        page: {
          margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 },
        },
      },
      children: [
        // Spacer
        p('', { spacingAfter: 600 }),

        // Title
        p('CERTIFICATE OF MASTERY', {
          center: true,
          bold: true,
          size: 48,
          color: '2563EB',
          spacingAfter: 400,
        }),

        // Divider line
        p('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━', {
          center: true,
          color: '2563EB',
          spacingAfter: 400,
        }),

        // Awarded to
        p('This certifies mastery of', { center: true, size: 22, color: '666666', spacingAfter: 200 }),

        // Course name (template token)
        p('{{ courseName }}', { center: true, bold: true, size: 36, spacingAfter: 400 }),

        // Stats
        p('Overall Mastery Score: {{ overallMastery }}', { center: true, size: 26, bold: true, color: '16A34A', spacingAfter: 200 }),
        p('Mastery Threshold: {{ masteryThreshold }}', { center: true, size: 22, color: '666666', spacingAfter: 300 }),

        // Divider
        p('───────────────────────────────────', { center: true, color: 'CCCCCC', spacingAfter: 300 }),

        // Details
        p('Bloom\'s Taxonomy Levels Achieved: {{ bloomLevelsAchieved }}', { center: true, size: 22, spacingAfter: 200 }),
        p('Pages Studied: {{ totalPagesStudied }}', { center: true, size: 22, spacingAfter: 200 }),
        p('Quizzes Completed: {{ totalQuizzesTaken }}', { center: true, size: 22, spacingAfter: 400 }),

        // Date
        p('Completed on {{ completionDate }}', { center: true, size: 22, color: '666666', spacingAfter: 200 }),

        // Spacer
        p('', { spacingAfter: 400 }),

        // Footer
        p('Generated by CoursePilot — AI-Powered Learning', { center: true, size: 18, color: '999999' }),
      ],
    },
  ],
});

// ─── Study Report Template ───────────────────────────────
const reportDoc = new Document({
  sections: [
    {
      properties: {
        page: {
          margin: { top: 1080, right: 1080, bottom: 1080, left: 1080 },
        },
      },
      children: [
        // Title
        p('Learning Portfolio — Study Report', { bold: true, size: 36, color: '2563EB', spacingAfter: 100 }),
        p('{{ courseName }}', { bold: true, size: 28, spacingAfter: 200 }),

        // Overview section
        p('Overview', { bold: true, size: 28, color: '2563EB', spacingAfter: 200 }),
        p('Overall Mastery: {{ overallMastery }}', { size: 22, spacingAfter: 100 }),
        p('Total Pages: {{ totalPages }}', { size: 22, spacingAfter: 100 }),
        p('Pages Mastered: {{ pagesMastered }}', { size: 22, spacingAfter: 100 }),
        p('Report Date: {{ completionDate }}', { size: 22, spacingAfter: 400 }),

        // ── Page Progress Table ──────────────────────────
        p('Page Progress', { bold: true, size: 28, color: '2563EB', spacingAfter: 200 }),

        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            // Header row
            new TableRow({
              children: [
                headerCell('#', 10),
                headerCell('Page', 50),
                headerCell('Mastery', 20),
                headerCell('Status', 20),
              ],
            }),
            // Template data row
            new TableRow({
              children: [
                dataCell('{{ TableStart:pages }}{{ ROW_NUMBER }}', 10),
                dataCell('{{ pageTitle }}', 50),
                dataCell('{{ masteryScore }}', 20),
                dataCell('{{ status }}{{ TableEnd:pages }}', 20),
              ],
            }),
          ],
        }),

        p('', { spacingAfter: 400 }),

        // ── Bloom's Performance Table ────────────────────
        p('Bloom\'s Taxonomy Performance', { bold: true, size: 28, color: '2563EB', spacingAfter: 200 }),

        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({
              children: [
                headerCell('Cognitive Level', 34),
                headerCell('Questions Attempted', 33),
                headerCell('Correct Rate', 33),
              ],
            }),
            new TableRow({
              children: [
                dataCell('{{ TableStart:bloomPerformance }}{{ level }}', 34),
                dataCell('{{ questionsAttempted }}', 33),
                dataCell('{{ correctRate }}{{ TableEnd:bloomPerformance }}', 33),
              ],
            }),
          ],
        }),

        p('', { spacingAfter: 400 }),

        // ── Missed Questions Table ───────────────────────
        p('Questions to Review', { bold: true, size: 28, color: '2563EB', spacingAfter: 200 }),

        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({
              children: [
                headerCell('Question', 50),
                headerCell('Bloom\'s Level', 25),
                headerCell('Correct Answer', 25),
              ],
            }),
            new TableRow({
              children: [
                dataCell('{{ TableStart:missedQuestions }}{{ question }}', 50),
                dataCell('{{ bloomLevel }}', 25),
                dataCell('{{ correctAnswer }}{{ TableEnd:missedQuestions }}', 25),
              ],
            }),
          ],
        }),

        p('', { spacingAfter: 400 }),

        // ── Chat Insights Table ──────────────────────────
        p('AI Chat Insights', { bold: true, size: 28, color: '2563EB', spacingAfter: 200 }),

        new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          rows: [
            new TableRow({
              children: [
                headerCell('Topic Discussed', 70),
                headerCell('Messages', 30),
              ],
            }),
            new TableRow({
              children: [
                dataCell('{{ TableStart:chatTopics }}{{ topic }}', 70),
                dataCell('{{ messageCount }}{{ TableEnd:chatTopics }}', 30),
              ],
            }),
          ],
        }),

        p('', { spacingAfter: 400 }),

        // Footer
        p('Generated by CoursePilot — AI-Powered Learning', { center: true, size: 18, color: '999999' }),
      ],
    },
  ],
});

// ─── Write files ─────────────────────────────────────────

const certBuffer = await Packer.toBuffer(certificateDoc);
writeFileSync('public/templates/certificate-template.docx', certBuffer);
console.log('Created: public/templates/certificate-template.docx');

const reportBuffer = await Packer.toBuffer(reportDoc);
writeFileSync('public/templates/study-report-template.docx', reportBuffer);
console.log('Created: public/templates/study-report-template.docx');
